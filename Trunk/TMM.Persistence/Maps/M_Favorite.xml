<?xml version="1.0" encoding="utf-8" ?> 
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.BatisMap.cst at 2011-1-10 9:28:25
//				By xincai.wu
//===========================================================================-->
<sqlMap namespace="MFavorite"
	xmlns="http://ibatis.apache.org/mapping" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

	<alias>
		<typeAlias alias="MFavorite" type="TMM.Model.MFavorite,TMM.Models" />		
	</alias>

	<statements>

		<select id="GetCount"  parameterClass="map" resultClass="System.Int32">
			SELECT count(*) FROM [M_Favorite]
			<dynamic prepend="WHERE">
				<isPropertyAvailable property="UserId" prepend="AND">
					[UserId] = #UserId#
				</isPropertyAvailable>
				<isPropertyAvailable property="DocId" prepend="AND">
					[DocId] = #DocId#
				</isPropertyAvailable>
				<isPropertyAvailable property="CreateTime" prepend="AND">
					[CreateTime] = #CreateTime#
				</isPropertyAvailable>
				<isPropertyAvailable property="FavCateId" prepend="AND">
					[FavCateId] = #FavCateId#
				</isPropertyAvailable>
				<isPropertyAvailable property="FavCatalog" prepend="AND">
					[FavCatalog] = #FavCatalog#
				</isPropertyAvailable>
			</dynamic>
		</select>
		

		<select id="GetList" parameterClass="map" resultClass="MFavorite">
			SELECT
			[FavId]
			, [UserId]
			, [DocId]
			, [CreateTime]
			, [FavCateId]
			, [FavCatalog]
			, [Title]
			, [NickName] as [U_UserInfo.NickName]
			, [Email] as [U_UserInfo.Email]
			, [DocType]
			, [HeadIcon] as [U_UserInfo.HeadIcon]
			FROM
			(SELECT
			<isPropertyAvailable property="Top" prepend="">
				Top (#Top#)
			</isPropertyAvailable>
			<isPropertyAvailable property="OrderBy" prepend="">
				ROW_NUMBER() OVER (order by $OrderBy$) as RowNumber,
			</isPropertyAvailable>
			a.*,b.Title,b.DocType,c.NickName,c.Email,c.HeadIcon
			FROM [M_Favorite] a
			LEFT JOIN [D_DocInfo] b ON a.DocId=b.DocId
			LEFT JOIN [U_UserInfo] c ON b.UserId=c.UserId
			<dynamic prepend="WHERE">
				<isPropertyAvailable property="UserId" prepend="AND">
					a.[UserId] = #UserId#
				</isPropertyAvailable>
				<isPropertyAvailable property="DocId" prepend="AND">
					a.[DocId] = #DocId#
				</isPropertyAvailable>
				<isPropertyAvailable property="CreateTime" prepend="AND">
					[CreateTime] = #CreateTime#
				</isPropertyAvailable>
				<isPropertyAvailable property="FavCateId" prepend="AND">
					[FavCateId] = #FavCateId#
				</isPropertyAvailable>
				<isPropertyAvailable property="FavCatalog" prepend="AND">
					[FavCatalog] = #FavCatalog#
				</isPropertyAvailable>
			</dynamic>
			) t
			<dynamic prepend="WHERE">
				<isPropertyAvailable property="StartRecord" prepend="AND">
				RowNumber>#StartRecord#
				</isPropertyAvailable>
			</dynamic>
		</select>
		
		<select id="Get" parameterClass="Int32" resultClass="MFavorite">
			SELECT
				[FavId]
				, [UserId]
				, [DocId]
				, [CreateTime]
				, [FavCateId]
				, [FavCatalog]
			FROM [M_Favorite]
			WHERE
				([FavId] = #FavId#)
		</select>
		
		

		
		<insert id="Insert" parameterClass="MFavorite" resultClass="Int32">
			INSERT INTO [M_Favorite] (
				 [UserId]
				, [DocId]
				, [CreateTime]
				, [FavCateId]
				, [FavCatalog]
			) VALUES (
				 #UserId#
				, #DocId#
				, #CreateTime#
				, #FavCateId#
				, #FavCatalog#
			)
			
			SELECT @@IDENTITY
		</insert>

		<update id="Update" parameterClass="MFavorite" resultClass="Int32">
			UPDATE [M_Favorite] SET
				 [UserId] = #UserId#
				, [DocId] = #DocId#
				, [CreateTime] = #CreateTime#
				, [FavCateId] = #FavCateId#
				, [FavCatalog] = #FavCatalog#
			WHERE
				([FavId] = #FavId#)
				
			SELECT @@rowcount
		</update>

		<delete id="Delete" parameterClass="int32" resultClass="Int32">
			<!--更新收藏夹的文档数量-->
			UPDATE [M_Catalog] SET [DocCount]=[DocCount]-1 WHERE CateId=(SELECT FavCateId FROM M_Favorite WHERE FavId=#FavId#)
			DELETE FROM [M_Favorite]
			WHERE
			([FavId] = #FavId#)

			select @@rowcount
		</delete>

		<update id="MoveFolder" parameterClass="map" resultClass="Int32">
			<!--更新收藏夹的文档数量-->
			UPDATE [M_Catalog] SET [DocCount]=[DocCount]+1 WHERE CateId=#FavCateId#
			UPDATE [M_Catalog] SET [DocCount]=[DocCount]-1 WHERE CateId=(SELECT FavCateId FROM M_Favorite WHERE FavId=#FavId#)
			<!--移动收藏夹-->
			UPDATE [M_Favorite] SET [FavCateId]=#FavCateId# WHERE FavId=#FavId#

		</update>
		
	</statements>
</sqlMap>
